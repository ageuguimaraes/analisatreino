<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Analisador de Treino & Saúde</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css" integrity="" crossorigin="anonymous">
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#60a5fa;
    --z1:#60a5fa; --z2:#10b981; --z3:#f59e0b; --z4:#f97316; --z5:#ef4444;
    color-scheme: dark;
  }
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#071022 0%, #07162a 100%);
    color:#e6eef8; margin:0; padding:16px;
  }
  .container{ max-width:1000px; margin:0 auto; }
  header{ display:flex; gap:12px; align-items:center; margin-bottom:12px;}
  h1{ font-size:1.25rem; margin:0; }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); margin-bottom:12px; }
  form .row{ display:flex; gap:10px; flex-wrap:wrap; }
  label{ font-size:0.85rem; color:var(--muted); display:block; margin-bottom:6px; }
  input[type="text"], input[type="number"], select, textarea, input[type="time"]{
    width:100%; background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:8px; color:inherit;
    font-size:0.95rem;
  }
  .col{ flex:1 1 220px; min-width:180px; }
  .full { flex:1 1 100%; }
  .small{ flex:0 0 120px; }
  .modes input{ margin-right:6px; }
  textarea{ min-height:80px; resize:vertical; }
  .actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  button{ background:var(--accent); color:#07203a; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
  button.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
  .result{ margin-top:12px; display:flex; gap:12px; flex-direction:column; }
  .status-ok{ color:#10b981; font-weight:700; }
  .status-warn{ color:#f59e0b; font-weight:700; }
  .status-bad{ color:#ef4444; font-weight:700; }
  .zones-svg{ width:100%; height:56px; display:block; margin-top:8px; border-radius:8px; overflow:hidden; }
  .zone-legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .legend-item{ display:flex; gap:6px; align-items:center; font-size:0.85rem; color:var(--muted); }
  .legend-color{ width:14px; height:14px; border-radius:3px; }
  footer{ margin-top:18px; font-size:0.82rem; color:var(--muted); }
  @media (max-width:700px){
    header{ flex-direction:column; align-items:flex-start; gap:6px; }
  }
  /* accessibility focus */
  :focus{ outline:3px solid rgba(96,165,250,0.18); outline-offset:2px; }
</style>
</head>
<body>
<div class="container" role="main">
  <header>
    <h1>Analise de Saúde e Sugerir Treino (LTHR & HRV)</h1>
    <div style="margin-left:auto;color:var(--muted);font-size:0.9rem">Acessível — desktop & mobile</div>
  </header>

  <section class="card" aria-labelledby="status-saudetitle">
    <h2 id="status-saudetitle" style="margin:0 0 8px 0;font-size:1rem">Status Saúde</h2>
    <form id="form">
      <div class="row">
        <div class="col">
          <label for="sexo">Sexo</label>
          <select id="sexo" aria-label="Sexo">
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
          </select>
        </div>
        <div class="small">
          <label for="idade">Idade</label>
          <input id="idade" type="number" min="13" max="99" value="37" aria-label="Idade">
        </div>
        <div class="col">
          <label for="lthr">Limiar de Lactato (LTHR) — bpm</label>
          <input id="lthr" type="number" min="50" max="220" value="183" aria-label="Limiar de lactato">
        </div>
      </div>

      <hr style="border:none;height:8px;opacity:0.03">

      <div style="margin-bottom:8px;font-weight:600;color:var(--muted)">VFC / HRV (ms) — preencher em ms</div>
      <div class="row" aria-live="polite">
        <div class="col">
          <label for="hrv_range">VFC - Linha de base (intervalo) — ex: 20-80 ms</label>
          <input id="hrv_range" type="text" placeholder="ex: 20-80" aria-label="Linhas de base da VFC">
        </div>
        <div class="col">
          <label for="hrv_7d">VFC média 7 dias (ms)</label>
          <input id="hrv_7d" type="number" min="0" value="60" aria-label="VFC média 7 dias">
        </div>
        <div class="col">
          <label for="hrv_last">VFC última noite (ms)</label>
          <input id="hrv_last" type="number" min="0" value="48" aria-label="VFC última noite">
        </div>
      </div>

      <hr style="border:none;height:8px;opacity:0.03">

      <div style="margin-bottom:8px;font-weight:600;color:var(--muted)">Sono (HH:MM cada)</div>
      <div class="row">
        <div class="small">
          <label for="sono_profundo">Profundo</label>
          <input id="sono_profundo" type="time" step="60" value="01:15" aria-label="Sono profundo">
        </div>
        <div class="small">
          <label for="sono_leve">Leve</label>
          <input id="sono_leve" type="time" step="60" value="04:30" aria-label="Sono leve">
        </div>
        <div class="small">
          <label for="sono_rem">REM</label>
          <input id="sono_rem" type="time" step="60" value="01:30" aria-label="Sono REM">
        </div>
        <div class="small">
          <label for="sono_acordado">Acordado</label>
          <input id="sono_acordado" type="time" step="60" value="00:15" aria-label="Tempo acordado">
        </div>
      </div>

      <hr style="border:none;height:8px;opacity:0.03">

      <div style="margin-bottom:8px;font-weight:600;color:var(--muted)">Modalidades (marque 1 ou mais)</div>
      <div class="modes card" style="display:flex;gap:12px;align-items:center;padding:10px;">
        <label><input type="checkbox" name="modal" value="Ciclismo" checked> Ciclismo</label>
        <label><input type="checkbox" name="modal" value="Corrida" checked> Corrida</label>
        <label><input type="checkbox" name="modal" value="Natação"> Natação</label>
        <label><input type="checkbox" name="modal" value="Musculação"> Musculação</label>
      </div>

      <div style="margin-top:8px;">
        <label for="treino_text">Treino proposto pelo técnico (descreva)</label>
        <textarea id="treino_text" placeholder="Ex: Aquecimento 15min Z1; 6x4min Z4 com 2min recuperação; desaquecimento 10min"></textarea>
      </div>

      <div class="actions" role="group" aria-label="Ações do formulário">
        <button type="button" id="analisar">Analisar & Gerar Sugestão</button>
        <button type="button" id="reset" class="ghost">Resetar dados</button>
        <button type="button" id="exportPdf" class="ghost">Exportar PDF</button>
        <button type="button" id="shareWhatsapp" class="ghost">Compartilhar via WhatsApp</button>
      </div>
    </form>

    <div id="output" class="result" aria-live="polite"></div>
  </section>

  <section class="card" aria-labelledby="zones-title">
    <h2 id="zones-title" style="margin:0 0 8px 0;font-size:1rem">Zonas Cardíacas (base LTHR)</h2>
    <div id="zonesInfo" class="full" aria-live="polite">
      <div id="zonesText" style="color:var(--muted)">Preencha um LTHR e clique em "Analisar & Gerar Sugestão".</div>
      <svg id="zonesSvg" class="zones-svg" viewBox="0 0 100 10" preserveAspectRatio="none" role="img" aria-label="Barras de zonas cardíacas" hidden>
        <!-- preenchido dinamicamente -->
      </svg>
      <div class="zone-legend" id="zoneLegend" aria-hidden="false"></div>
    </div>
  </section>

  <section class="card" aria-labelledby="sources-title">
    <h2 id="sources-title" style="margin:0 0 8px 0;font-size:1rem">Fontes / Referências</h2>
    <ul id="sourcesList" style="color:var(--muted);margin:0;padding-left:18px">
      <li>TrainingPeaks — explicações sobre thresholds e zonas cardíacas (Lactate Threshold as base). </li>
      <li>Garmin / artigos técnicos sobre cálculo de zonas %LTHR (ex.: explicações de %LTHR para zones). </li>
      <li>Estudos e revisões sobre HRV & sono e como baixa VFC/sono prejudicam recuperação (revistas científicas e revisões).</li>
    </ul>
    <div style="margin-top:8px;color:var(--muted);font-size:0.84rem">Observação: o gerador usa regras simples (heurísticas) — para decisões clínicas/condições médicas específicas, consulte um profissional de saúde.</div>
  </section>

  <footer>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <div style="color:var(--muted)">Feito para: Planejamento de treinos com LTHR & HRV.</div>
      <div style="margin-left:auto;color:var(--muted);font-size:0.82rem">© Ferramenta de sugestão — não substitui orientação profissional</div>
    </div>
  </footer>
</div>

<!-- Dependências para export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="" crossorigin="anonymous"></script>

<script>
/*
  Lógica principal:
  - lê inputs
  - converte tempos HH:MM em minutos
  - decide "OK para treino" com regras simples:
      * Se VFC última noite < 0.85 * VFC_7d  => alerta (reduzir intensidade)
      * Se sono total < 360 minutos (6h) => alerta
      * Se sono profundo < 45 minutos => alerta leve
    (essas regras são heurísticas — podem ser ajustadas)
  - se alerta: gera treino alternativo (reduz intensidade: troca Z4/Z5 por Z2/Z3 e reduz repetições)
  - cria zonas %LTHR e ranges em bpm e desenha barras SVG coloridas.
  - export PDF com jsPDF e compartilhar via WhatsApp (abre link com mensagem codificada)
*/

function timeToMinutes(hhmm){
  if(!hhmm) return 0;
  // input type=time returns "HH:MM"
  const parts = hhmm.split(':');
  if(parts.length<2) return 0;
  return parseInt(parts[0],10)*60 + parseInt(parts[1],10);
}

function calcZonesFromLTHR(lthr){
  // Uso mapeamento %LTHR comumente usado:
  // Z1: < 80% (recuperacao)
  // Z2: 80-89%
  // Z3: 90-95%
  // Z4: 95-100%
  // Z5: >100%
  const zones = [
    {id:'Z1', name:'Recuperação', pctLow:0.00, pctHigh:0.80, color:getComputedStyle(document.documentElement).getPropertyValue('--z1')||'#60a5fa'},
    {id:'Z2', name:'Aeróbico (Endurance)', pctLow:0.80, pctHigh:0.89, color:getComputedStyle(document.documentElement).getPropertyValue('--z2')||'#10b981'},
    {id:'Z3', name:'Tempo (Moderado)', pctLow:0.89, pctHigh:0.95, color:getComputedStyle(document.documentElement).getPropertyValue('--z3')||'#f59e0b'},
    {id:'Z4', name:'Limiar (Hard)', pctLow:0.95, pctHigh:1.00, color:getComputedStyle(document.documentElement).getPropertyValue('--z4')||'#f97316'},
    {id:'Z5', name:'VO2máx / Sprint', pctLow:1.00, pctHigh:1.15, color:getComputedStyle(document.documentElement).getPropertyValue('--z5')||'#ef4444'},
  ];
  // compute bpm ranges
  zones.forEach(z=>{
    z.bpmLow = Math.round(z.pctLow * lthr);
    z.bpmHigh = Math.round(z.pctHigh * lthr);
    // fix for display if pctLow 0
    if(z.pctLow===0){ z.bpmLow = 0; }
  });
  return zones;
}

function drawZonesSvg(zones){
  const svg = document.getElementById('zonesSvg');
  const legend = document.getElementById('zoneLegend');
  svg.innerHTML = '';
  legend.innerHTML = '';
  svg.removeAttribute('hidden');
  // We'll map zones into proportions across width, using defined pctHigh - pctLow
  const totalWidth = 100; // viewBox units
  const groups = zones.map(z=>({w: (z.pctHigh - z.pctLow)*100, color:z.color, label:z.id, z}));
  let x=0;
  groups.forEach(g=>{
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', x.toString());
    rect.setAttribute('y','0');
    rect.setAttribute('width', g.w.toString());
    rect.setAttribute('height','10');
    rect.setAttribute('fill', g.color.trim() || '#888');
    rect.setAttribute('stroke','rgba(0,0,0,0.12)');
    svg.appendChild(rect);

    // label text small center
    const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x', (x + g.w/2).toString());
    txt.setAttribute('y', '6.5');
    txt.setAttribute('font-size','1.8');
    txt.setAttribute('text-anchor','middle');
    txt.setAttribute('fill','rgba(255,255,255,0.9)');
    txt.textContent = g.label;
    svg.appendChild(txt);

    // legend
    const item = document.createElement('div');
    item.className='legend-item';
    const sw = document.createElement('span');
    sw.className='legend-color';
    sw.style.background=g.color;
    item.appendChild(sw);
    const t = document.createElement('span');
    t.textContent = `${g.label} ${g.z.bpmLow}–${g.z.bpmHigh} bpm`;
    item.appendChild(t);
    legend.appendChild(item);

    x += g.w;
  });
}

function hhmmToText(hhmm){
  if(!hhmm) return '00:00';
  return hhmm;
}

function totalSleepMinutes(profundo, leve, rem, acordado){
  return profundo + leve + rem; // acordado geralmente não soma para sono total
}

function generateAlternativeWorkout(originalText, selectedModalities, zones){
  // Heurística simples: reduzir intensidade e transformar intervalos em steady Z2/Z3
  let modalText = selectedModalities.join(', ');
  let alt = `Treino alternativo (reduzido) — ${modalText}:\n`;
  alt += `- Aquecimento 10-15 min em Z1-Z2\n`;
  // if original mentions intervals, replace with steady tempo
  alt += `- Trabalho principal: 20-40 min contínuo em Z2 (manter cadência/ritmo confortável) ou intervalos leves 6x3min em Z3 com 3min recuperação em Z1\n`;
  alt += `- Desaquecimento 8-12 min Z1\n`;
  alt += `Observação: reduzir cargas/intensidade em ~10% do LTHR e priorizar execução técnica e recuperação.\n`;
  alt += `Motivo: condições de recuperação (VFC/sono) indicam reduzir estresse fisiológico.`;
  return alt;
}

function analyzeAndSuggest(){
  const sexo = document.getElementById('sexo').value;
  const idade = Number(document.getElementById('idade').value) || 0;
  const lthr = Number(document.getElementById('lthr').value) || 0;
  const hrvRange = document.getElementById('hrv_range').value || '';
  const hrv7 = Number(document.getElementById('hrv_7d').value) || 0;
  const hrvLast = Number(document.getElementById('hrv_last').value) || 0;
  const profundo = timeToMinutes(document.getElementById('sono_profundo').value);
  const leve = timeToMinutes(document.getElementById('sono_leve').value);
  const rem = timeToMinutes(document.getElementById('sono_rem').value);
  const acordado = timeToMinutes(document.getElementById('sono_acordado').value);
  const totalSleep = totalSleepMinutes(profundo, leve, rem, acordado);
  const treinoText = document.getElementById('treino_text').value || '(não fornecido)';
  const modElems = Array.from(document.querySelectorAll('input[name="modal"]:checked'));
  const modalities = modElems.map(m=>m.value);
  const output = document.getElementById('output');

  // Basic checks
  const messages = [];
  let status = 'ok'; // ok, warn, bad
  // HRV rule: if last night < 0.85 * 7d mean => alert
  if(hrv7>0 && hrvLast > 0 && hrvLast < 0.85 * hrv7){
    messages.push(`VFC última noite (${hrvLast} ms) < 85% da média 7 dias (${hrv7} ms) — sinal de recuperação reduzida.`);
    status = 'warn';
  }
  // Sleep rule
  if(totalSleep < 360){
    messages.push(`Sono total ~${Math.round(totalSleep/60)}h < 6h — limite baixo de sono para treino intenso.`);
    status = status==='ok' ? 'warn' : status;
  }
  if(profundo < 45){
    messages.push(`Sono profundo curto (${Math.round(profundo)} min) — pode reduzir recuperação neuromuscular.`);
    if(status==='ok') status='warn';
  }
  // if multiple warnings → recommend reduced
  if(messages.length >= 2) status = 'bad';

  // Construct result area
  output.innerHTML = '';
  const statDiv = document.createElement('div');
  if(status==='ok'){
    statDiv.innerHTML = `<div class="status-ok" role="status">Condição: OK para executar o treino proposto.</div>`;
  } else if(status==='warn'){
    statDiv.innerHTML = `<div class="status-warn" role="status">Condição: Atenção — considerar reduzir intensidade.</div>`;
  } else {
    statDiv.innerHTML = `<div class="status-bad" role="status">Condição: Não recomendada para treino intenso — sugere treino alternativo.</div>`;
  }
  // show reasons
  const reasons = document.createElement('div');
  reasons.style.color='var(--muted)';
  reasons.style.marginTop='8px';
  if(messages.length) reasons.innerHTML = '<strong>Observações:</strong><br>' + messages.map(m=>`• ${m}`).join('<br>');
  else reasons.innerHTML = '<div style="color:var(--muted)">Nenhuma observação crítica encontrada.</div>';

  output.appendChild(statDiv);
  output.appendChild(reasons);

  // zones
  if(lthr>0){
    const zones = calcZonesFromLTHR(lthr);
    drawZonesSvg(zones);

    // present table
    const zoneBlock = document.createElement('div');
    zoneBlock.style.marginTop='8px';
    zoneBlock.innerHTML = `<strong>Zonas (base LTHR = ${lthr} bpm)</strong>`;
    const ul = document.createElement('ul');
    ul.style.color='var(--muted)';
    ul.style.margin='8px 0 0 18px';
    zones.forEach(z=>{
      const li = document.createElement('li');
      li.textContent = `${z.id} — ${z.name}: ${z.bpmLow} a ${z.bpmHigh} bpm (${Math.round(z.pctLow*100)}%–${Math.round(z.pctHigh*100)}% LTHR)`;
      ul.appendChild(li);
    });
    zoneBlock.appendChild(ul);
    output.appendChild(zoneBlock);
  }

  // original treino block
  const orig = document.createElement('div');
  orig.style.marginTop='10px';
  orig.innerHTML = `<strong>Treino proposto pelo técnico:</strong><div style="color:var(--muted);white-space:pre-wrap;margin-top:6px">${treinoText}</div>`;
  output.appendChild(orig);

  // alternative if needed
  if(status!=='ok'){
    const alt = generateAlternativeWorkout(treinoText, modalities.length?modalities:['Geral'], calcZonesFromLTHR(lthr||160));
    const altDiv = document.createElement('div');
    altDiv.style.marginTop='10px';
    altDiv.innerHTML = `<strong>Sugestão alternativa:</strong><div style="color:var(--muted);white-space:pre-wrap;margin-top:6px">${alt}</div>`;
    output.appendChild(altDiv);
  }

  // Add quick summary info for sharing/export
  const summary = {
    sexo, idade, lthr, hrvRange, hrv7, hrvLast, totalSleepMinutes: totalSleep,
    profundo, leve, rem, acordado, modalities, treinoText, status, messages
  };
  // store for export & share
  output.dataset.summary = JSON.stringify(summary);
}

document.getElementById('analisar').addEventListener('click', analyzeAndSuggest);
document.getElementById('reset').addEventListener('click', ()=>{
  document.getElementById('form').reset();
  // reset some defaults (optional)
  document.getElementById('idade').value = 37;
  document.getElementById('lthr').value = 183;
  document.getElementById('hrv_7d').value = 60;
  document.getElementById('hrv_last').value = 48;
  document.getElementById('sono_profundo').value = '01:15';
  document.getElementById('sono_leve').value = '04:30';
  document.getElementById('sono_rem').value = '01:30';
  document.getElementById('sono_acordado').value = '00:15';
  document.getElementById('zonesSvg').setAttribute('hidden','');
  document.getElementById('zoneLegend').innerHTML='';
  document.getElementById('output').innerHTML='';
});

document.getElementById('shareWhatsapp').addEventListener('click', ()=>{
  const out = document.getElementById('output');
  if(!out.dataset.summary){
    alert('Gere a sugestão primeiro (clique em "Analisar & Gerar Sugestão").');
    return;
  }
  const s = JSON.parse(out.dataset.summary);
  let msg = `Sugestão de treino — status: ${s.status}\\n`;
  msg += `Sexo: ${s.sexo}, Idade: ${s.idade}\\nLTHR: ${s.lthr} bpm\\nVFC 7d: ${s.hrv7} ms, Última: ${s.hrvLast} ms\\nSono total: ${Math.round(s.totalSleepMinutes/60)}h\\n`;
  msg += `Modalidades: ${s.modalities.join(', ')}\\nTreino técnico: ${s.treinoText}\\n`;
  msg += `Observações: ${s.messages.join(' | ')}\\n`;
  msg += `Gerado por ferramenta de sugestão.`;
  const encoded = encodeURIComponent(msg);
  const waLink = `https://wa.me/?text=${encoded}`;
  window.open(waLink,'_blank');
});

document.getElementById('exportPdf').addEventListener('click', async ()=>{
  const out = document.getElementById('output');
  if(!out.dataset.summary){
    alert('Gere a sugestão primeiro (clique em "Analisar & Gerar Sugestão").');
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const summary = JSON.parse(out.dataset.summary);
  const lines = [];
  lines.push('Sugestão de Treino - Export');
  lines.push('');
  lines.push(`Status: ${summary.status}`);
  lines.push(`Sexo: ${summary.sexo} — Idade: ${summary.idade}`);
  lines.push(`LTHR: ${summary.lthr} bpm`);
  lines.push(`VFC (7d): ${summary.hrv7} ms — Última noite: ${summary.hrvLast} ms`);
  lines.push(`Sono total (aprox): ${Math.round(summary.totalSleepMinutes/60)} h`);
  lines.push(`Modalidades: ${summary.modalities.join(', ')}`);
  lines.push('');
  lines.push('Treino proposto pelo técnico:');
  lines.push(summary.treinoText || '(não fornecido)');
  lines.push('');
  if(summary.messages && summary.messages.length){
    lines.push('Observações:');
    summary.messages.forEach(m=>lines.push('- ' + m));
  }

  // write lines
  const left = 40; let top = 40;
  const lineHeight = 14;
  doc.setFontSize(11);
  lines.forEach(l=>{
    doc.text(l, left, top);
    top += lineHeight;
    if(top > 750){ doc.addPage(); top = 40; }
  });
  // Save
  doc.save('sugestao_treino.pdf');
});


// Accessibility: enable Enter on form to trigger analyze
document.getElementById('form').addEventListener('submit', (e)=>{ e.preventDefault(); analyzeAndSuggest(); });

// Small initial draw if lthr present
(function init(){
  const l = Number(document.getElementById('lthr').value);
  if(l>0){
    document.getElementById('zonesSvg').removeAttribute('hidden');
    drawZonesSvg(calcZonesFromLTHR(l));
  }
})();
</script>
</body>
</html>
